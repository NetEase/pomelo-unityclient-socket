{
  "name": "pomelo-admin",
  "version": "0.3.2",
  "private": false,
  "dependencies": {
    "pomelo-scheduler": "0.3.8",
    "pomelo-logger": "0.1.2",
    "pomelo-monitor": "0.3.7",
    "socket.io": "0.9.16",
    "socket.io-client": "0.9.16",
    "ndump": ">=0.0.2"
  },
  "devDependencies": {
    "should": ">=0.0.1",
    "mocha": ">=0.0.1",
    "flow": ">=0.0.1"
  },
  "readme": "#pomelo-admin\n\n`pomelo-admin` is an admin console library for [pomelo](https://github.com/NetEase/pomelo). It provides the a series of utilities to monitor the `pomelo` server clusters.\n\n##Installation\n\n```\nnpm install pomelo-admin\n```\n\n##Basic conception\n\n###Process roles\n\nThere are three process roles in `pomelo-admin`: master, monitor and client.\n\n+ master - the master server process, collects and maintains all the client and monitor status and exports the cluster status for the clients.  \n\n+ monitor - monitor proxy, in every server process which needs to be monitored. It should be started during the process starts and registers itself to the master server and reports the monitored process status to the master. \n\n+ client - `pomelo-admin` client process that fetches the status from master server, such as [pomelo-admin-web](https://github.com/NetEase/pomelo-admin-web) and [pomelo-cli](https://github.com/NetEase/pomelo-cli).\n\n###Message types\n\nThere are two message types of the communication between processes.\n\n+ request - bidirectional message that cooperated with response.\n\n+ notify - unidirectional message.\n\n##Components\n\n###ConsoleService \n\nMain service of `pomelo-admin` that runs in both master and monitor processes. It maintains the master agent or monitor agent for the process, loads the registed modules and provides the messages routing service for the messages from other processes.\n\n###MasterAgent  \n\n`pomelo-admin` agent that runs on the master process to provide the basic network communication and protocol encoding and decoding.\n\n###MonitorAgent  \n\n`pomelo-admin` agent that runs on the monitor process to provide the basic network communication and protocol encoding and decoding. \n\n###Module  \n \nModule is the place to implement the monitor logic, such as process status collecting. Developer can register modules in `pomelo-admin` to customize all kinds of system monitors.\n\nThere are three optional callback functions in each module.\n\n* function masterHandler(agent, msg, cb) - callback in master process to process a message from monitor process or a timer event in master process.\n\n* function monitorHandler(agent, msg, cb) - callback in monitor process to process a message from master process or a timer event in monitor process.\n\n* function clientHandler(agent, msg, cb) - callback in master process to process a message from client.\n\nThe relations of the components is as below:\n\n<center>\n![pomelo-admin-arch](http://pomelo.netease.com/resource/documentImage/pomelo-admin-arch.png)\n</center>\n\n##Usage\n\n```javascript\nvar admin = require(\"pomelo-admin\");\n```\n\nCreate a consoleService instance in master process.\n\n```javascript\nvar masterConsole = admin.createMasterConsole({  \n    port: masterPort  \n});  \n```\n\nRegister an admin module.\n\n```javascript\nmasterConsole.register(moduleId, module);  \n```\n\nStart masterConsole.\n\n```javascript\nmasterConsole.start(function(err) {  \n  // start servers  \n});  \n```\n\nCreate a consoleService instance in monitor process. \n\n```javascript\nvar monitorConsole = admin.createMonitorConsole({  \n    id: serverId,  \n    type: serverType,  \n    host: masterInfo.host,  \n    port: masterInfo.port,  \n    info: serverInfo  \n}); \n```\n\n##Customized modules  \n\nDevelopers can customize modules to collect and export additional status as they need.\n\n###Simple example  \n\n```javascript\nvar Module = function(app, opts) {\n  opts = opts || {};\n  this.type = opts.type || 'pull';  // pull or push \n  this.interval = opts.interval || 5; // pull or push interval\n};\n\nModule.moduleId = 'helloPomelo';\n\nmodule.exports = Module;\n\nModule.prototype.monitorHandler = function(agent, msg) {\n  var word = agent.id + ' hello pomelo';\n  // notify admin messages to master\n  agent.notify(Module.moduleId, {serverId: agent.id, body: word});\n};\n\nModule.prototype.masterHandler = function(agent, msg) {\n  // if no message, then notify all monitors to fetch datas\n  if(!msg) {\n    agent.notifyAll(Module.moduleId);\n    return;\n  }\n  // collect data from monitor\n  var data = agent.get(Module.moduleId);\n  if(!data) {\n    data = {};\n    agent.set(Module.moduleId, data);\n  }\n\n  data[msg.serverId] = msg;\n};\n\nModule.prototype.clientHandler = function(agent, msg, cb) {\n  // deal with client request,directly return data cached in master\n  cb(null, agent.get(Module.moduleId) || {});\n};\n```\n\n###Register customized modules\n\nyou must register your customized modules to pomelo to make it work.  \nwrite in app.js which is in your project's root directory  \n\n```javascript\napp.configure('production|development', function() {\n  app.registerAdmin('helloPomelo',new helloPomelo());\n});\n```\n\n##User level control  \npomelo-admin defines user level for admin client to login master server in this schema  \n```javascript\n{\n    \"id\": \"user-1\",\n    \"username\": \"admin\",\n    \"password\": \"admin\",\n    \"level\": 1\n}\n```\n\n**level** defines the user admin level  \nlevel 1 means the user has the admin permission, this user can do anything  \nother level user will have limited permission  \ncurrently **add**, **stop**, **kill** will require level 1 permission  \n\n**note**: by default you should provide adminUser.json file under the **config** dir  \nadminUser.json\n```\n[{\n    \"id\": \"user-1\",\n    \"username\": \"admin\",\n    \"password\": \"admin\",\n    \"level\": 1\n}, {\n    \"id\": \"user-2\",\n    \"username\": \"monitor\",\n    \"password\": \"monitor\",\n    \"level\": 2\n},{\n    \"id\": \"user-3\",\n    \"username\": \"test\",\n    \"password\": \"test\",\n    \"level\": 2\n}\n]\n```\n\n##Self-defined auth \npomelo-admin provides a simple auth function in [pomelo-admin auth](https://github.com/NetEase/pomelo-admin/blob/master/lib/util/utils.js#L78)  \ndevelopers can provide self-defined auth in pomelo by  \nin master server\n```javascript\napp.set('adminAuthUser', function(msg, cb){\n  if(auth success) {\n    cb(user);\n  } else {\n    cb(null);\n  }\n})\n```\n\n##Server master auth  \nserver connect to master with authorization  \npomelo-admin provides a simple auth function in [pomelo-admin auth](https://github.com/NetEase/pomelo-admin/blob/master/lib/util/utils.js#L117)  \ndevelopers can provide self-defined auth in pomelo by  \nin master server\n```javascript\napp.set('adminAuthServerMaster', function(msg, cb){\n  if(auth success) {\n    cb('ok');\n  } else {\n    cb('bad');\n  }\n})\n```\n\nin monitor server\n```javascript\napp.set('adminAuthServerMonitor', function(msg, cb){\n  if(auth success) {\n    cb('ok');\n  } else {\n    cb('bad');\n  }\n})\n```\n\n**note**: by default you should provide adminServer.json file under the **config** dir  \nadminServer.json\n```\n[{\n    \"type\": \"connector\",\n    \"token\": \"agarxhqb98rpajloaxn34ga8xrunpagkjwlaw3ruxnpaagl29w4rxn\"\n}, {\n    \"type\": \"chat\",\n    \"token\": \"agarxhqb98rpajloaxn34ga8xrunpagkjwlaw3ruxnpaagl29w4rxn\"\n},{\n    \"type\": \"gate\",\n    \"token\": \"agarxhqb98rpajloaxn34ga8xrunpagkjwlaw3ruxnpaagl29w4rxn\"\n}\n]\n```\n\n**type** is the serverType, **token** is a string you can genrate by yourself  \nwhen using in pomelo, you should fill all your servers with type:token  \n\n###Notes  \n\n`pomelo-admin` provides a series of useful system modules by default. But most of them are turned off by default. Add a simple line of code in `app.js` as below to enable them.\n\n```javascript\napp.configure('development', function() {\n  // enable the system monitor modules\n  app.enable('systemMonitor');\n});\n```\n",
  "readmeFilename": "README.md",
  "description": "`pomelo-admin` is an admin console library for [pomelo](https://github.com/NetEase/pomelo). It provides the a series of utilities to monitor the `pomelo` server clusters.",
  "_id": "pomelo-admin@0.3.2",
  "_from": "pomelo-admin@0.3.2"
}
